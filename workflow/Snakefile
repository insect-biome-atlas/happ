from snakemake.utils import validate
from scripts.common import read_taxa

validate(config, schema="schemas/config.schema.yaml", set_default=True)
taxa = read_taxa(config)
wildcard_constraints:
    prog = "(swarm|opticlust|dbotu3|lulu)",
    taxa = taxa,
    rundir = config["rundir"]

container: "docker://continuumio/miniconda3:4.11.0"
include: "rules/common.smk"
include: "rules/swarm.smk"
include: "rules/dbotu3.smk"
include: "rules/opticlust.smk"
include: "rules/lulu.smk"

rule all:
    input:
        expand("results/{prog}/{rundir}/asv_clusters.tsv",
            rundir = config["rundir"], prog = config["software"])

def cluster_files(wildcards, taxa):
    input = []
    rundir = config["rundir"]
    for prog in config["software"]:
        run_name = config[prog]["run_name"]
        for tax in taxa:
            input.append(f"results/{prog}/{rundir}/{tax}/{run_name}/asv_clusters.tsv")
    return input

rule collate:
    input:
        cluster_files(taxa)
    output:
        "results/{prog}/{rundir}/asv_clusters.tsv"
    script:
        "scripts/common.py"
